<!DOCTYPE html>
<html lang="en">
	<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>ESP-IDF Vulnerabilities</title>
		<link rel="stylesheet" href="css/style.css">

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.css">
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.js"></script>

        <!-- DataTables Buttons extension -->
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

        <!-- JSZip (required for Excel export) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

        <!-- pdfmake (required for PDF export) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
	</head>

	<body>
		<header>
			<div class="site-header">
				<h1 class="site-title"><a href=".">ESP-IDF Vulnerabilities</a></h1>
				<img class="site-logo" src="images/espressif-logo.png" alt="Espressif Logo">
			</div>
		</header>
		<main>
            <p>
                This page details known vulnerabilities affecting released
                ESP-IDF versions, current as of ${datetime} UTC. Additional
                insights into known vulnerabilities can be found in the
                <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/security/vulnerabilities.html">Vulnerabilities</a>
                page of the ESP-IDF Programming Guide.
            </p>

            <p>
            <strong>Vulnerable status:</strong>
            <strong>YES</strong> - version is confirmed to be vulnerable,
            <strong>MAYBE</strong> - version might be vulnerable and needs further review,
            <strong>EXCLUDED</strong> - vulnerability does not apply to this version,
            <strong>NO</strong> - there are no known vulnerabilities
            </p>

            <p>
            <strong>Search:</strong> The input is split into words, and each word is matched
            independently in any column, in any order. Matching is case-insensitive and
            supports regular expressions.
            </p>

            <table id="report" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>release</th>
                        <th>cve</th>
                        <th>vulnerable</th>
                        <th>severity</th>
                        <th>package</th>
                        <th>version</th>
                        <th>description</th>
                    </tr>
                </thead>
            </table>
		</main>
	</body>

    <script>
        jQuery.extend(jQuery.fn.dataTable.ext.type.order, {
            "version-pre": function (version) {
                const parts = version.split('.').map(p => parseInt(p) || 0);
                while (parts.length < 3) parts.push(0); // pad to [major, minor, patch]
                return parts[0] * 1e6 + parts[1] * 1e3 + parts[2];
            }
        });

        jQuery.extend(jQuery.fn.dataTable.ext.type.order, {
            "release-pre": function (v) {
                // Remove the "v" prefix
                v = v.trim().replace(/^v/i, '');

                // Extract main version and suffix
                const [main, suffix] = v.split('-');

                const parts = main.split('.').map(p => parseInt(p, 10) || 0);
                while (parts.length < 3) parts.push(0);

                // Boost score for "-next" suffix
                const bump = suffix === 'next' ? 1 : 0;

                // Generate sortable number (higher is newer)
                return parts[0] * 1e9 + parts[1] * 1e6 + parts[2] * 1e3 + bump;
            }
        });

        const vulnerable_sort_map = {
            "SKIPPED": 0,
            "NO": 1,
            "EXCLUDED": 2,
            "MAYBE": 3,
            "YES": 4
        };

        jQuery.extend(jQuery.fn.dataTable.ext.type.order, {
            "vulnerable-pre": function (data) {
                return vulnerable_sort_map[data.trim()] ?? -1;
            }
        });

        const severity_sort_map = {
            "LOW": 0,
            "MEDIUM": 1,
            "HIGH": 2,
            "CRITICAL": 3
        };

        jQuery.extend(jQuery.fn.dataTable.ext.type.order, {
            "severity-pre": function (data) {
                return severity_sort_map[data.trim()] ?? -1;
            }
        });

        $(document).ready(function() {
            var rows = ${rows};

            $('#report').DataTable({
                data: rows,
                columns: [
                    { title: "release", data: "release", type: "release" },
                    { title: "cve", data: "cve" },
                    { title: "vulnerable", data: "vulnerable", type: "vulnerable" },
                    { title: "severity", data: "severity", type: "severity" },
                    { title: "package", data: "package" },
                    { title: "version", data: "version", type: "version" },
                    { title: "description", data: "description" }
                ],
                order: [
                    [0, 'desc'],
                    [2, 'desc'],
                    [3, 'desc']
                ],
                dom: 'Bfrtip',  // B = Buttons
                buttons: [
                    'excelHtml5',
                    'csvHtml5',
                    {
                        extend: 'pdfHtml5',
                        orientation: 'landscape'
                    }
                ],
                search: {
                    regex: true, // Enable regular expression search
                },
                scrollX: true,
                pageLength: 50 // Set the default number of entries to be shown
            });
        });
    </script>
</html>
